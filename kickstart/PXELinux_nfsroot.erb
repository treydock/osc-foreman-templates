<%#
kind: snippet
name: OSC - PXELinux NFS root
oses:
- CentOS
- Fedora
- RedHat
- RHEL Server
%>
#
# This file was deployed via '<%= @template_name %>' template
#
# Supported host/hostgroup parameters:
#
# blacklist = module1, module2
#   Blacklisted kernel modules
#
<%= snippet "OSC - include" %>
<%
  append = []
  append << "initrd=#{@tftp_boot_prefix}#{@nfsroot_initrd}"
  append << "network"
  if @host.operatingsystem.major.to_i >= 7
    append << "net.ifnames=0 biosdevname=0"
    append << "root=nfs:#{@nfsroot_host}:#{@nfsroot_path},#{@nfsroot_opts}"
  end

  # These arguments get used by the readonly-root service on both RHEL6 and RHEL7
  if @nfsroot_ro
    append << "ro readonlyroot"
  elsif @nfsroot_rw
    append << "rw noreadonlyroot"
  end

  if @host.provider == 'BareMetal'
    append << "console=tty"
    if @host.params['console_tty']
      append << "console=#{@host.params['console_tty']},115200"
    else
      append << "console=ttyS0,115200"
    end
  end

  # Disable Supervisor Mode Access Prevention on RHEL7 systems that are known to be broadwell
  if @host.operatingsystem.major.to_i >= 7
    if @host.hostgroup.present? && ['base/compute/owens', 'base/login/owens'].include?(@host.hostgroup.to_s)
      append << "nosmap"
    end
  end

  append << "rd.lvm=0 rd.md=0 rd.dm=0"

  primary_interface = @host.primary_interface
  if primary_interface.type == 'Nic::Bond'
    name = primary_interface.identifier
    slaves = primary_interface.attached_devices
    bondopts = primary_interface.bond_options.split(/\s/)
    bondopts << "mode=#{primary_interface.mode}"
    bondopts = bondopts.join(',')
    bond = "bond=#{name}:#{slaves}:#{bondopts}"
  else
    bond = ""
  end
  append << bond

  append = append.join(' ')
-%>

LABEL nfsroot
    KERNEL <%= "#{@tftp_boot_prefix}#{@nfsroot_kernel}" %>
    APPEND <%= append %>
    MENU DEFAULT
    IPAPPEND 2
