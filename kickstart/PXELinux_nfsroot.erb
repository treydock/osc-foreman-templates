<%#
kind: snippet
name: OSC - PXELinux NFS root
oses:
- CentOS
- Fedora
- RedHat
- RHEL Server
%>
#
# This file was deployed via '<%= @template_name %>' template
#
# Supported host/hostgroup parameters:
#
# blacklist = module1, module2
#   Blacklisted kernel modules
#
<%
  @nfsroot_rw_hostgroups = [
    'base/rw/owens',
  ]
  @nfsroot_ro_hostgroups = [
    'base/compute/owens',
    'base/login/owens',
  ]
  append = []
  append << "initrd=#{@initrd}"
  append << "network"
  if @host.operatingsystem.major.to_i >= 7
    append << "net.ifnames=0 biosdevname=0"
    append << "root=nfs:10.11.200.3:/owens_root_rhel72_0,vers=3,tcp,rw,nfsvers=3,async,rsize=65536,wsize=65536"
  end

  # These arguments get used by the readonly-root service on both RHEL6 and RHEL7
  if @host.hostgroup.present? && @nfsroot_ro_hostgroups.include?(@host.hostgroup.to_s)
    append << "readonlyroot"
  elsif @host.hostgroup.present? && @nfsroot_rw_hostgroups.include?(@host.hostgroup.to_s)
    append << "noreadonlyroot"
  end

  if @host.provider == 'BareMetal'
    append << "console=tty"
    if @host.params['console_tty']
      append << "console=#{@host.params['console_tty']},115200"
    else
      append << "console=ttyS0,115200"
    end
  end

  # Disable Supervisor Mode Access Prevention on RHEL7 systems that are known to be broadwell
  if @host.operatingsystem.major.to_i >= 7
    if @host.hostgroup.present? && ['base/compute/owens', 'base/login/owens'].include?(@host.hostgroup.to_s)
      append << "nosmap"
    end
  end

  primary_interface = @host.primary_interface
  if primary_interface.type == 'Nic::Bond'
    name = primary_interface.identifier
    slaves = primary_interface.attached_devices
    bondopts = primary_interface.bond_options.split(/\s/)
    bondopts << "mode=#{primary_interface.mode}"
    bondopts = bondopts.join(',')
    bond = "bond=#{name}:#{slaves}:#{bondopts}"
  else
    bond = ""
  end
  append << bond

  append = append.join(' ')
-%>

<% if @host.hostgroup.present? && (@nfsroot_rw_hostgroups.include?(@host.hostgroup.to_s) || @nfsroot_ro_hostgroups.include?(@host.hostgroup.to_s)) -%>
LABEL nfsroot
    KERNEL <%= @kernel %>
    APPEND <%= append %>
    IPAPPEND 2

<% end -%>
