<%#
kind: snippet
name: puppet_setup
description: this snippet will configure the Puppet agent
%>
<%
if @host.param_true?('enable-puppetlabs-pc1-repo')
  linux_package = 'puppet-agent'
  etc_path = '/etc/puppetlabs/puppet'
  bin_path = '/opt/puppetlabs/bin'
else
  linux_package = 'puppet'
  etc_path = '/etc/puppet'
  bin_path = '/usr/bin'
end
%>

yum -t -y install <%= linux_package %>

cat > <%= etc_path %>/puppet.conf << EOF
<%= snippet 'puppet.conf' %>
EOF

<% unless @host.param_true?('enable-puppetlabs-pc1-repo') -%>
/sbin/chkconfig --level 345 puppet on
<% end -%>

<%= bin_path %>/puppet agent --config <%= etc_path %>/puppet.conf --onetime --tags mofed <%= @host.puppetmaster.blank? ? '' : "--server #{@host.puppetmaster}" %> --no-daemonize
